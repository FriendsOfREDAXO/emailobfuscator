<!DOCTYPE html>
<html>
<head>
    <title>Email Obfuscation Test</title>
</head>
<body>
    <h1>Email Obfuscation Test</h1>
    
    <!-- Test XOR Simple Method -->
    <h2>XOR Simple Method</h2>
    <span class="email-obfuscated" 
          data-method="xor-simple" 
          data-email="MQgSHSwqGgcYAw8EWgwdJg" 
          data-text="MQgSHSwqGgcYAw8EWgwdJg" 
          data-attributes="">test@example.com</span>

    <!-- Test XOR Dynamic Method -->
    <h2>XOR Dynamic Method</h2>
    <span class="email-obfuscated" 
          data-method="xor-dynamic" 
          data-context="123"
          data-email="RVYWFiYDSARcQwkHSAVfCA" 
          data-text="RVYWFiYDSARcQwkHSAVfCA" 
          data-attributes="">test@example.com</span>

    <!-- JavaScript to test decryption -->
    <script>
    (function() {
        function base64UrlDecode(str) {
            str = (str + "===").slice(0, str.length + (str.length % 4));
            return atob(str.replace(/-/g, "+").replace(/_/g, "/"));
        }

        function xorDecrypt(encrypted, key) {
            var result = "";
            for (var i = 0; i < encrypted.length; i++) {
                result += String.fromCharCode(encrypted.charCodeAt(i) ^ key.charCodeAt(i % key.length));
            }
            return result;
        }

        function decryptEmailData(encryptedData, method, context) {
            var key;
            if (method === "xor-simple") {
                key = "EmailObfuscatorKey2024";
            } else {
                // Generate dynamic key using a simple hash
                var baseKey = "EmailObfuscator";
                var fullString = baseKey + (context || "");
                var hash = 0;
                for (var i = 0; i < fullString.length; i++) {
                    var char = fullString.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash; // Convert to 32-bit integer
                }
                // Convert hash to hex and take first 16 characters
                var hashHex = Math.abs(hash).toString(16);
                key = (hashHex + hashHex + hashHex + hashHex).substring(0, 16);
            }
            
            var decoded = base64UrlDecode(encryptedData);
            return xorDecrypt(decoded, key);
        }

        function deobfuscateEmails() {
            var obfuscatedElements = document.querySelectorAll(".email-obfuscated");
            
            obfuscatedElements.forEach(function(element) {
                var method = element.getAttribute("data-method");
                var context = element.getAttribute("data-context") || "";
                var encryptedEmail = element.getAttribute("data-email");
                var encryptedText = element.getAttribute("data-text");
                var encryptedAttributes = element.getAttribute("data-attributes");
                
                try {
                    var email = decryptEmailData(encryptedEmail, method, context);
                    var text = decryptEmailData(encryptedText, method, context);
                    var attributes = encryptedAttributes ? decryptEmailData(encryptedAttributes, method, context) : "";
                    
                    var link = document.createElement("a");
                    link.href = "mailto:" + email;
                    link.textContent = text;
                    
                    if (attributes) {
                        // Simple attribute parsing
                        var attrParts = attributes.split(" ");
                        attrParts.forEach(function(attr) {
                            var eqIndex = attr.indexOf("=");
                            if (eqIndex > 0) {
                                var attrName = attr.substring(0, eqIndex);
                                var attrValue = attr.substring(eqIndex + 1).replace(/["']/g, "");
                                if (attrName && attrValue && attrName !== "href") {
                                    link.setAttribute(attrName, attrValue);
                                }
                            }
                        });
                    }
                    
                    element.parentNode.replaceChild(link, element);
                    console.log("Deobfuscated:", email);
                } catch (e) {
                    console.warn("Failed to deobfuscate email:", e);
                }
            });
        }

        // Initialize when DOM is ready
        if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", deobfuscateEmails);
        } else {
            deobfuscateEmails();
        }
    })();
    </script>
</body>
</html>